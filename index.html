<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Fiscal - Sincronizado</title>
    <style>
        :root { --orange: #ff6600; --dark: #121212; --card: #1e1e1e; --green: #00ff88; --white: #e0e0e0; --red: #ff4444; --yellow: #ffcc00; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: var(--white); margin: 0; padding: 20px; }
        .dashboard { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1400px; margin: 0 auto; }
        .module { flex: 1; min-width: 380px; background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        h2 { color: var(--orange); text-transform: uppercase; font-size: 1rem; border-bottom: 2px solid var(--orange); padding-bottom: 10px; margin-bottom: 20px; }
        .status-nuem { font-size: 10px; color: var(--green); margin-bottom: 10px; display: block; }
        label { display: block; color: var(--orange); font-weight: bold; font-size: 11px; text-transform: uppercase; margin: 15px 0 5px 0; }
        select, input { width: 100%; padding: 12px; background: #121212; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }
        .tax-status { font-weight: bold; text-transform: uppercase; padding: 3px 6px; border-radius: 4px; font-size: 10px; }
        .status-sim { color: var(--green); border: 1px solid var(--green); }
        .status-nao { color: var(--red); border: 1px solid var(--red); }
        .hidden { display: none; }
        #adminPanel { background: #252525; border: 1px dashed var(--orange); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .btn-admin { background: var(--orange); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; }
        footer { position: fixed; bottom: 10px; right: 20px; opacity: 0.3; cursor: pointer; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="module">
        <h2>1. Identificação</h2>
        <span id="syncStatus" class="status-nuem">⏳ Sincronizando códigos com a nuvem...</span>
        <label>CNPJ Prestador</label>
        <input type="text" id="cnpjInput" placeholder="00.000.000/0000-00" onblur="buscarPrestador()">
        <div id="resPrestador" style="display:none; margin-top:10px; font-size:12px;">
            Regime: <span id="resRegime" style="color:var(--green)"></span>
        </div>
        <label style="margin-top:15px;">Tomador</label>
        <select id="tipoTomador" onchange="validarFluxo()">
            <option value="">-- Selecione --</option>
            <option value="PJ">Pessoa Jurídica</option>
            <option value="CONDOMINIO">Condomínio</option>
        </select>
    </div>

    <div class="module locked" id="mod2">
        <h2>2. Regras de Retenção</h2>
        
        <div id="adminPanel" class="hidden">
            <h4 style="color:var(--green); font-size:11px; margin:0 0 10px 0;">ÁREA DO CRIADOR</h4>
            <input type="text" id="newCod" placeholder="Cód: 7.02" style="margin-bottom:5px;">
            <input type="text" id="newDesc" placeholder="Descrição" style="margin-bottom:5px;">
            <button class="btn-admin" onclick="salvarNaMascara()">SALVAR E GERAR TEXTO PARA NUVEM</button>
            <textarea id="outputNuvem" class="hidden" style="margin-top:10px; height:60px; font-size:10px; background:#000; color:var(--green); border:1px solid var(--green);"></textarea>
            <p id="msgNuvem" class="hidden" style="font-size:9px; color:var(--white);">Copie o texto acima e cole no seu GitHub Gist.</p>
        </div>

        <label>Código de Serviço</label>
        <select id="fedCodeSelect" onchange="processarRegras()">
            <option value="">Carregando...</option>
        </select>

        <div style="margin-top: 20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>ISS</span><span id="stISS" class="tax-status">--</span></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>IRRF</span><span id="stIRRF" class="tax-status">--</span></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>PCC</span><span id="stPCC" class="tax-status">--</span></div>
            <div style="display:flex; justify-content:space-between;"><span>INSS</span><span id="stINSS" class="tax-status">--</span></div>
        </div>
    </div>
</div>

<footer onclick="ativarAdmin()">⚙️</footer>

<script>
    // URL DA SUA NUVEM (Exemplo de um Gist Público)
    // Você criará o seu e substituirá aqui
const LINK_NUVEM = "https://gist.githubusercontent.com/SEU_USUARIO/ID_DO_GIST/raw/regras.json";

    let REGRAS = {};
    let regimePrestador = "";

    async function carregarNuvem() {
        try {
            // Se o link da nuvem falhar ou não estiver configurado, usa a base local
            const response = await fetch(LINK_NUVEM);
            if (response.ok) {
                REGRAS = await response.json();
                document.getElementById('syncStatus').innerText = "✅ Códigos atualizados via nuvem";
            }
        } catch (e) {
            REGRAS = { "1.01": {iss:"S", ir:1.5, pcc:4.65, inss:11, desc:"Análise (Local)"} };
            document.getElementById('syncStatus').innerText = "⚠️ Modo Offline (Base Local)";
        }
        popularSelect();
    }

    function popularSelect() {
        const select = document.getElementById('fedCodeSelect');
        select.innerHTML = '<option value="">-- Selecione o Código --</option>';
        Object.keys(REGRAS).sort().forEach(key => {
            const opt = document.createElement('option');
            opt.value = key;
            opt.innerText = `${key} - ${REGRAS[key].desc}`;
            select.appendChild(opt);
        });
    }

    function salvarNaMascara() {
        const cod = document.getElementById('newCod').value;
        const desc = document.getElementById('newDesc').value;
        if(!cod || !desc) return alert("Preencha dados");

        REGRAS[cod] = { iss:"S", ir:1.5, pcc:4.65, inss:11, desc: desc };
        
        const area = document.getElementById('outputNuvem');
        area.value = JSON.stringify(REGRAS, null, 2);
        area.classList.remove('hidden');
        document.getElementById('msgNuvem').classList.remove('hidden');
        popularSelect();
        alert("Novo código adicionado localmente. Agora siga os passos para atualizar o link do cliente.");
    }

    function ativarAdmin() { if(prompt("Senha:") === "admin123") document.getElementById('adminPanel').classList.remove('hidden'); }
    
    function validarFluxo() {
        const t = document.getElementById('tipoTomador').value;
        document.getElementById('mod2').className = t ? "module" : "module locked";
    }

    function buscarPrestador() {
        const cnpj = document.getElementById('cnpjInput').value.replace(/\D/g, '');
        if (cnpj.length !== 14) return;
        const script = document.createElement('script');
        script.src = `https://receitaws.com.br/v1/cnpj/${cnpj}?callback=callbackPrestador`;
        document.body.appendChild(script);
    }

    function callbackPrestador(dados) {
        regimePrestador = (dados.simples && dados.simples.optante) ? "SIMPLES" : "NORMAL";
        document.getElementById('resRegime').innerText = regimePrestador;
        document.getElementById('resPrestador').style.display = 'block';
    }

    function processarRegras() {
        const code = document.getElementById('fedCodeSelect').value;
        const tomador = document.getElementById('tipoTomador').value;
        if (!REGRAS[code]) return;
        const r = REGRAS[code];
        
        const ir = (regimePrestador !== "SIMPLES" && tomador !== "CONDOMINIO" && r.ir > 0);
        atualizarStatus('stISS', r.iss === "S" ? "S" : "N");
        atualizarStatus('stIRRF', ir ? "S" : "N");
        atualizarStatus('stPCC', (regimePrestador !== "SIMPLES") ? "S" : "N");
        atualizarStatus('stINSS', r.inss > 0 ? "S" : "N");
    }

    function atualizarStatus(id, valor) {
        const el = document.getElementById(id);
        el.innerText = valor === "S" ? "SIM" : "NÃO";
        el.className = "tax-status " + (valor === "S" ? "status-sim" : "status-nao");
    }

    carregarNuvem();
</script>
</body>

</html>
